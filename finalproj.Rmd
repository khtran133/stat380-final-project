---
title: "R Notebook"
output: html_notebook
---

```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(mosaic)
library(plyr)
library(ggplot2)
library(rvest)
library(reshape2)
```

```{r}
# options
# display as decimal, not scientific notation
options(scipen = 999)

# data for 2013 - 2016
county_poverty <- read.csv(file = 'county_poverty_hist.csv', header = TRUE, sep = ',')
county_poverty$geo_sumlevel <- gsub('[[:punct:]]\\s', '', str_extract(county_poverty$geo_name, '\\,\\s[A-Z]{2}'))
county_poverty$geo_name <- gsub('\\,\\s[A-Z]{2}', '', county_poverty$geo_name)
county_poverty <- county_poverty[-3]

# naming scheme:
# pYEAR = number of people in poverty, for the given year
# prYEAR = poverty rate, for the given year
# popYEAR = total population, for the given year
# tall data set
names(county_poverty) <- c('county', 'state', 'p2013', 'p2014', 'p2015', 'pr2013', 'pr2014', 'pr2015', 'pr2016', 'p2016', 'pop2013', 'pop2014', 'pop2015', 'pop2016')
county_poverty <- county_poverty %>% 
  na.omit() %>%
  select(sort(current_vars()))

# remove Puerto Rico
county_poverty <- county_poverty %>% 
  filter(state != 'PR')

county_poverty <- county_poverty %>% 
  select(sort(current_vars()))
```

```{r}
# economic/unemployment data
# https://apps.bea.gov/regional/
ec <- read.csv('CAINC4__ALL_STATES_1969_2017.csv', header = TRUE, sep = ',')
ec <- ec[, c('GeoFIPS', 'GeoName', 'Description', 'X2013', 'X2014', 'X2015', 'X2016')]
ec$Description <- gsub('[[:punct:]]', '', ec$Description) %>% 
  trimws()

# keep 'Per capita personal income (dollars) 4/', 'Total employment', 'Farm proprietors' income', 'Nonfarm proprietors' income'
# clean data
ec <- ec %>% filter(ec$Description == 'Per capita personal income dollars 4' | 
                      ec$Description == 'Total employment' | 
                      ec$Description == 'Farm proprietors income' | 
                      ec$Description == 'Nonfarm proprietors income')
ec$Description[ec$Description == 'Per capita personal income dollars 4'] <- 'income'
ec$Description[ec$Description == 'Total employment'] <- 'empl_count'
ec$Description[ec$Description == 'Farm proprietors income'] <- 'farm_income'
ec$Description[ec$Description == 'Nonfarm proprietors income'] <- 'nonfarm_income'
ec <- dcast(melt(ec, 
                 id.vars = c('GeoFIPS', 'GeoName', 'Description'), 
                 measure.vars = c('X2013', 'X2014', 'X2015', 'X2016')), 
            GeoFIPS + GeoName + variable ~ Description) %>% 
  mutate(variable = gsub('X', '', variable))
ec[, 1:2] <- lapply(ec[, 1:2], as.character)
ec[, c(1, 3:7)] <- lapply(ec[, c(1, 3:7)], as.numeric)
ec$p_farm_income <- ec$farm_income / ec$nonfarm_income
ec[is.na(ec)] <- 0

# state data
## COMBINE WITH 'STATE_DATA' DATA FRAME
state_ec <- ec[(ec$GeoFIPS %% 1000 == 0), ]
state_ec <- state_ec %>% 
  filter(GeoFIPS < 90000 & GeoFIPS != 0)
state_ec <- subset(state_ec, select = -c(GeoFIPS))
names(state_ec) <- c('state', 'year', 'empl_count', 'farm_income', 'income', 'nonfarm_income', 'p_farm_income')
```

```{r}
# create tall data set
cp1 <- gather(county_poverty[c(1:5, 14)], year, poverty_count, p2013:p2016, factor_key = TRUE) %>% 
  mutate(year = str_extract(year, '\\d{4}'))
cp2 <- gather(county_poverty[c(1, 6:9, 14)], year, total_count, pop2013:pop2016, factor_key = TRUE) %>% 
  mutate(year = str_extract(year, '\\d{4}'))
cp <- merge(cp1, cp2, by = c('county', 'state', 'year')) %>% 
  mutate(poverty_rate = poverty_count / total_count,
         year = year %>% as.numeric())
cp$county <- gsub('\\sCounty', '', cp$county)
cp$county <- gsub('\\sParish', '', cp$county)
cp$county <- gsub('\\scity', '\\sCity', cp$county)
cp$county <- gsub('[[:punct:]]', '', cp$county)
cp$county <- cp$county %>% 
  trimws()

# county data
county_ec <- ec[!(ec$GeoFIPS %% 1000 == 0), ]
county_ec <- subset(county_ec, select = -c(GeoFIPS))
county_ec$state <- gsub('[[:punct:]]\\s', '', str_extract(county_ec$GeoName, '\\,\\s[A-Z]{2}'))
county_ec$GeoName <- gsub('\\,\\s[A-Z]{2}', '', county_ec$GeoName)
names(county_ec) <- c('county', 'year', 'empl_count', 'farm_income', 'income', 'nonfarm_income', 'p_farm_income', 'state')
county_ec$county <- gsub('[[:punct:]]', '', county_ec$county)
county_ec$county <- gsub('\\sIndependent\\sCity', '\\sCity', county_ec$county)
county_ec$county <- gsub('\\sStaunton\\sWaynesboro', '', county_ec$county)
county_ec$county <- county_ec$county %>% 
  trimws()

county_data <- merge(cp, county_ec, by = c('county', 'state', 'year'))
county_data$empl_rate <- county_data$empl_count / county_data$total_count

# 'county_ec' to wide
st <- list()
for (i in 2013:2016) {
  df <- county_ec %>% filter(year == i)
  df <- df[, -2]
  df_names <- names(df)
  df_names[2] <- paste('ec', i %>% as.character(), sep = '')
  df_names[3] <- paste('f_inc', i %>% as.character(), sep = '')
  df_names[4] <- paste('inc', i %>% as.character(), sep = '')
  df_names[5] <- paste('nf_inc', i %>% as.character(), sep = '')
  df_names[6] <- paste('pf_inc', i %>% as.character(), sep = '')
  names(df) <- df_names
  st[[i - 2012]] <- df
}

county_ec_wide <- merge(st[[1]], st[[2]], by = c('state', 'county'))
county_ec_wide <- merge(county_ec_wide, st[[3]], by = c('state', 'county'))
county_ec_wide <- merge(county_ec_wide, st[[4]], by = c('state', 'county'))

# clean county names for good merging
county_poverty$county <- gsub('\\sCounty', '', county_poverty$county)
county_poverty$county <- gsub('\\sParish', '', county_poverty$county)
county_poverty$county <- gsub('\\scity', '\\sCity', county_poverty$county)
county_poverty$county <- gsub('[[:punct:]]', '', county_poverty$county)
county_poverty$county <- county_poverty$county %>% 
  trimws()

# merge 'county_ec_wide' with 'state_poverty'
state_data_wide <- merge(county_ec_wide, county_poverty, by = c('state', 'county'))
```

```{r}
# data set of poverty, by state
state_poverty <- table(state_data_wide$state) %>% 
  data.frame()
names(state_poverty) <- c('state', 'n_counties')

# 51 = number of states, including Washington D.C.
# create a data table of summary stats per state
sp <- list()
for(i in 1:51) {
  state_stats <- data.frame(summary(state_data_wide[which(state_data_wide$state == state_poverty$state[i]), ]))[13:204, 2:3] %>% 
  mutate(stat = gsub('\\s*\\:', '', str_extract(Freq, '.*\\:')), 
         Freq = gsub(':', '', str_extract(Freq, '\\:.+')) %>% as.numeric()) %>% 
  reshape(idvar = 'Var2', timevar = 'stat', direction = 'wide') %>%
  mutate(Year = str_extract(Var2, '\\d{4}'), 
         Var2 = str_extract(Var2, '[cefinopr_]{1,6}'), 
         state = state_poverty$state[i])
  sp[[i]] <- state_stats
}

# clean data, rename variables and reorganize column order
state_poverty <- merge(state_poverty, do.call(rbind, sp), by = 'state') %>% 
  select(sort(current_vars()))
state_poverty <- state_poverty[, c(8, 10, 7, 9, 1:6)]
state_poverty$Var2[state_poverty$Var2 == 'p'] <- 'poverty_count'
state_poverty$Var2[state_poverty$Var2 == 'pr'] <- 'poverty_rate'
state_poverty$Var2[state_poverty$Var2 == 'pop'] <- 'total_count'
state_poverty$Var2[state_poverty$Var2 == 'ec'] <- 'empl_count'
state_poverty$Var2[state_poverty$Var2 == 'f_inc'] <- 'farm_income'
state_poverty$Var2[state_poverty$Var2 == 'inc'] <- 'income'
state_poverty$Var2[state_poverty$Var2 == 'f_inc'] <- 'farm_income'
state_poverty$Var2[state_poverty$Var2 == 'nf_inc'] <- 'nonfarm_income'
state_poverty$Var2[state_poverty$Var2 == 'pf_inc'] <- 'p_farm_income'
names(state_poverty) <- c('state', 'year', 'n_counties', 'countystat', '1st_quantile', '3rd_quantile', 'max', 'mean', 'median', 'minimum')

# merge 'cp' with 'county_ec'
county_data_tall <- merge(cp, county_ec, by = c('state', 'county', 'year'))
  
# create variables measuring the standard deviation and variance of county stats, per year
state_variance <- c()
state_sd <- c()
for(i in 1:nrow(state_poverty)) {
  state_variance[i] <- county_data_tall %>% 
    filter(state == state_poverty$state[i] & year == state_poverty$year[i]) %>% 
    select(state_poverty$countystat[i]) %>% 
    var()
  state_sd[i] <- sapply(county_data_tall %>% filter(state == state_poverty$state[i] & year == state_poverty$year[i]) %>% select(state_poverty$countystat[i]), sd)[[1]][1]
}

state_poverty$var <- state_variance
state_poverty$sd <- state_sd
state_poverty[is.na(state_poverty)] <- 0

# merge state stats with statistics on total state population ('state_ec'), total state poverty count, and overall state poverty rate (aggregating 'cp')
# scrape from Wikipedia to transform full state names into abbreviated two letters
for(i in 1:nrow(state_ec)) {
  if(state_ec$state[i] == 'District of Columbia') {
    state_ec$state[i] <- 'DC'
  } else {
    state_ec$state[i] <- state.abb[grep(state_ec$state[i], state.name)]
  }
}

state_st <- merge(state_ec, 
                       merge(aggregate(poverty_count ~ state + year, cp, sum), 
                             aggregate(total_count ~ state + year, cp, sum), 
                             by = c('state', 'year')) %>% 
                         mutate(poverty_rate = poverty_count / total_count), 
                       by = c('state', 'year')) %>% 
  mutate(empl_rate = empl_count / total_count)
state_poverty <- merge(state_poverty, state_st, by = c('state', 'year'))


# rename state-wide variables for clarity
names(state_poverty) <- c('state', 'year', 'n_counties', 'countystat', '1st_quantile', '3rd_quantile', 'max', 'mean', 'median', 'minimum', 'var', 'sd', 'state_empl_count', 'state_farm_income', 'state_avg_income', 'state_nonfarm_income', 'state_p_farm_income', 'state_poverty_count', 'state_total_count', 'state_poverty_rate', 'state_empl_rate')
```


```{r}
# crime data
state_crime <- read.csv(file = 'estimated_crimes.csv', header = TRUE, sep = ',')
state_data <- merge(state_poverty, state_crime[, -c(2, 4:5, 15)], by.x = c('year', 'state'), by.y = c('year', 'state_abbr')) %>% 
  mutate(state_vcrime_rate = violent_crime / state_total_count,
         state_pcrime_rate = property_crime / state_total_count)
state_data <- state_data[, c(1:12, 19, 15, 13, 21, 17:18, 22, 31, 27, 32, 20)]

# explain 'state_data' variables below
```